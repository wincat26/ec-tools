AI ç‡Ÿé‹é¡§å•ç³»çµ± â€” ç³»çµ±æ¶æ§‹èˆ‡è³‡æ–™æµç¨‹

æª”æ¡ˆç‰ˆæœ¬ï¼š v1.0
æª”åï¼š 04_System_Architecture_And_DataFlow.md
å»ºç«‹æ—¥æœŸï¼š 2025-10-31
æª”æ¡ˆæ“¬å®šäººï¼š RedDoor Interactive Data Team

1ï¸âƒ£ æª”æ¡ˆç›®çš„ï¼ˆPurposeï¼‰

æœ¬æª”æ¡ˆæ—¨åœ¨æ¸…æ¥šå®šç¾© AI ç‡Ÿé‹é¡§å•ç³»çµ±çš„ï¼š

è³‡æ–™ä¾†æºï¼ˆData Sourcesï¼‰

ç³»çµ±æ¶æ§‹ï¼ˆSystem Architectureï¼‰

è³‡æ–™æµå‘ï¼ˆETL Flow & Data Pipelineï¼‰

å®‰å…¨æ§ç®¡èˆ‡æ›´æ–°é€±æœŸï¼ˆSecurity & Scheduleï¼‰

è¡¨æ ¼å‘½åèˆ‡é‚è¼¯çµæ§‹ï¼ˆSchema Designï¼‰

2ï¸âƒ£ ç³»çµ±ç¸½è¦½æ¶æ§‹åœ–ï¼ˆSystem Overviewï¼‰
flowchart LR
  A1[Shopline / Cyberbiz API] -->|æ¯æ—¥åŒ¯å…¥| B[BigQuery Staging]
  A2[GA4 Export Table] -->|è‡ªå‹•åŒæ­¥| B
  A3[Meta Ads / Google Ads API] -->|æ¯æ—¥åŒ¯å…¥| B
  B -->|ETL / Dataform Transformation| C[BigQuery Processed Layer]
  C -->|å®šæœŸæ›´æ–°| D[Dashboard & Guideline Engine]
  D -->|REST API / JSON| E[Next.js å‰ç«¯]
  D -->|æ–‡å­—ç”Ÿæˆ| F[OpenAI API / BQML]
  E -->|æ“ä½œäº’å‹•| G[Action Queue / Firebase]
  C -->|å ±è¡¨åŒ¯å‡º| H[LINE Notify / Email æ¨æ’­]

3ï¸âƒ£ æ¶æ§‹åˆ†å±¤èªªæ˜ï¼ˆLayered Architectureï¼‰
å±¤ç´š	åç¨±	èªªæ˜	æŠ€è¡“çµ„ä»¶
L1	Data Source å±¤	ä¾†æºç³»çµ±ï¼šé›»å•†å¹³å°ã€å»£å‘Šå¹³å°ã€GA4	Shopline API / Cyberbiz API / GA4 Export / Ads API
L2	Staging å±¤	æš«å­˜åŸå§‹è³‡æ–™ï¼Œé€²è¡Œæ¸…æ´—èˆ‡æ™‚é–“æ¨™æº–åŒ–	BigQuery Datasetï¼šraw_ å‰ç¶´
L3	Processing å±¤	æ•´åˆèˆ‡è½‰æ›è³‡æ–™ï¼Œè¨ˆç®—ç‡Ÿé‹æŒ‡æ¨™	Dataformï¼ˆSQLXï¼‰ + BigQuery
L4	Application å±¤	å‰ç«¯æŸ¥è©¢ã€AI åˆ†æèˆ‡ä»»å‹™åŸ·è¡Œ	Next.js + Node.js + Firebase
L5	Presentation å±¤	è¦–è¦ºåŒ–å„€è¡¨æ¿ã€å ±å‘Šèˆ‡ LINE é€šçŸ¥	Recharts / LINE API / Report Generator
4ï¸âƒ£ è³‡æ–™æµç¨‹èªªæ˜ï¼ˆETL Data Flowï¼‰
ğŸ§© Step 1ï¼šè³‡æ–™ä¾†æºæ”¶é›†ï¼ˆData Ingestionï¼‰
è³‡æ–™ä¾†æº	API / åŒ¯å‡ºæ–¹å¼	æ›´æ–°é »ç‡	ä¸»è¦æ¬„ä½
Shopline / Cyberbiz	REST API / CSV åŒ¯å‡º	æ¯æ—¥	è¨‚å–®ã€æœƒå“¡ã€å•†å“
GA4	BigQuery Export Table	æ¯æ—¥è‡ªå‹•åŒæ­¥	event_dateã€event_nameã€user_idã€page_location
Meta Ads / Google Ads	API via App Script / Connector	æ¯æ—¥	campaign_nameã€clicksã€impressionsã€cost
æ‰‹å‹•ä¸Šå‚³è£œæª”	Google Drive â†’ Dataform Trigger	ä¾éœ€æ±‚	æ´»å‹•ä»£è™Ÿã€æˆæœ¬èª¿æ•´è³‡æ–™

âš™ï¸ æ™‚é–“æ ¼å¼çµ±ä¸€ï¼š æ‰€æœ‰æ™‚é–“çµ±ä¸€è½‰æ›ç‚º Asia/Taipei
âš™ï¸ ä¸»éµé‚è¼¯ï¼š

Order ID â†’ è¨‚å–®å±¤å”¯ä¸€éµ

User ID â†’ é¡§å®¢å±¤å”¯ä¸€éµ

Event ID â†’ GA4 äº‹ä»¶å±¤å”¯ä¸€éµ

ğŸ§® Step 2ï¼šè³‡æ–™æ¸…æ´—èˆ‡è½‰æ›ï¼ˆTransformation / Dataformï¼‰

æ¸…æ´—è¦å‰‡ï¼š

æ™‚é–“æ¬„ä½ UTC â†’ å°ç£æ™‚å€ï¼ˆTIMESTAMP_SECONDS + INTERVAL 8 HOURï¼‰

é‡è¤‡è¨‚å–®éæ¿¾ï¼ˆä»¥æœ€æ–°ç‹€æ…‹ç‚ºä¸»ï¼‰

æœƒå“¡èˆ‡è¨‚å–®åˆä½µéµï¼šcustomer_id = user_id

å•†å“åˆ†é¡ä»¥ SKU / category_tag å°æ‡‰

GA4 event åƒ…ä¿ç•™ä¸»è¦äº‹ä»¶ï¼šview_itemã€add_to_cartã€begin_checkoutã€purchase

ç”¢å‡ºè¡¨çµæ§‹ï¼ˆProcessed Layerï¼‰ï¼š

è³‡æ–™é›†åç¨±	è³‡æ–™è¡¨	èªªæ˜
cdp_data	lv0_orders	è¨‚å–®å±¤ç´šè³‡æ–™ï¼ˆæ¯æ—¥æ›´æ–°ï¼‰
cdp_data	lv0_customers	æœƒå“¡è³‡æ–™ï¼ˆæ¯æ—¥æ›´æ–°ï¼‰
cdp_data	lv0_products	å•†å“å±¤è³‡æ–™
analytics_xxxxx	events_*	GA4 åŒ¯å‡ºäº‹ä»¶è¡¨
ad_data	meta_ads_daily	å»£å‘Šæˆæ•ˆè¡¨
ad_data	google_ads_daily	å»£å‘Šæˆæ•ˆè¡¨ï¼ˆGoogleï¼‰
processed	daily_summary	å½™ç¸½ç‡Ÿé‹æŒ‡æ¨™ï¼ˆç‡Ÿæ”¶ / æµé‡ / è½‰æ› / å®¢å–®ï¼‰
processed	source_metrics	ä¸ƒå¤§æµé‡ä¾†æº KPI çµ±è¨ˆ
processed	guideline_trigger	AI åˆ¤æ–·ç”¨ç•°å¸¸äº‹ä»¶è¡¨
ğŸ“Š Step 3ï¼šæŒ‡æ¨™é‹ç®—ï¼ˆKPI Calculationï¼‰

ä¸»è¦æŒ‡æ¨™ä¾æ“šç‡Ÿæ”¶å…¬å¼ï¼š

ç‡Ÿæ”¶ = æµé‡ Ã— è½‰æ›ç‡ Ã— å¹³å‡å®¢å–®åƒ¹

æŒ‡æ¨™	ä¾†æº	é‹ç®—é‚è¼¯
æµé‡ï¼ˆSessionsï¼‰	GA4 events	COUNT(DISTINCT session_id)
è½‰æ›ç‡ï¼ˆCVRï¼‰	GA4 + è¨‚å–®è¡¨	purchases / sessions
å¹³å‡å®¢å–®åƒ¹ï¼ˆAOVï¼‰	è¨‚å–®è¡¨	SUM(revenue) / COUNT(orders)
æ–°å®¢æ¯”ä¾‹	è¨‚å–®è¡¨ + æœƒå“¡è¡¨	COUNT(DISTINCT first_purchase) / total_customers
ç†±éŠ·å“è²¢ç»åº¦	å•†å“è¡¨	SUM(sales_per_product) / total_sales
å»£å‘Š ROAS	å»£å‘Šè¡¨ + è¨‚å–®è¡¨	revenue / ad_cost
ğŸ§  Step 4ï¼šGuideline æ¨¡å‹é‹ä½œé‚è¼¯ï¼ˆAI Layerï¼‰

è¦å‰‡è§¸ç™¼ï¼ˆRule-based Triggerï¼‰

è‹¥æŸæŒ‡æ¨™è®ŠåŒ–è¶…éé–€æª»ï¼ˆä¾‹ï¼šä¸‹é™ >10%ï¼‰â†’ å¯«å…¥ guideline_trigger

è§¸ç™¼é¡å‹åŒ…æ‹¬ï¼štraffic_dropã€conversion_dropã€aov_drop

AI æ–‡å­—ç”Ÿæˆ

æŸ¥è©¢è§¸ç™¼è¡¨ï¼Œå°‡ç•°å¸¸åŸå›  + ä¾†æºçµ„åˆæˆ prompt

é€é AI.GENERATE_TEXT_FROM_TABLE æˆ– OpenAI API ç”Ÿæˆå»ºè­°

è¼¸å‡ºæ ¼å¼ï¼š

{
  "category": "è½‰æ›ç‡",
  "insight": "è½‰æ›ç‡ä¸‹é™ 0.3%ï¼Œä¸»è¦å‡ºç¾åœ¨å»£å‘Šæµé‡ã€‚",
  "suggestion": "å»ºè­°èª¿æ•´ Meta Ads å—çœ¾ï¼Œèšç„¦æœ€è¿‘14å¤©è¨ªå®¢ã€‚"
}


è³‡æ–™è¼¸å‡º

å¯«å…¥ BigQuery è¡¨æ ¼ï¼šprocessed.guideline_suggestions

å‰ç«¯ä»¥ REST API æŸ¥è©¢é¡¯ç¤ºæ–¼ Guideline å€å¡Š

ğŸ”„ Step 5ï¼šå‰ç«¯è³‡æ–™è®€å–èˆ‡é¡¯ç¤ºï¼ˆApplication Layerï¼‰
åŠŸèƒ½æ¨¡çµ„	è®€å–ä¾†æº	API ç¯„ä¾‹
Dashboard Summary	processed.daily_summary	/api/v1/summary?date=2025-10-27
Traffic Source Table	processed.source_metrics	/api/v1/source-metrics?date_range=7d
Conversion Funnel	analytics_*.events_*	/api/v1/funnel?event=view_item
Product Breakdown	cdp_data.lv0_products	/api/v1/products/top10
Guideline å»ºè­°	processed.guideline_suggestions	/api/v1/guideline/latest
ä»»å‹™æ¸…å–®	Firebase / Firestore	/api/v1/tasks?user_id=123
5ï¸âƒ£ å®‰å…¨èˆ‡æ¬Šé™è¨­è¨ˆï¼ˆSecurity & IAMï¼‰
æ¨¡çµ„	æ§ç®¡æ–¹å¼	æ¬Šé™å±¤ç´š
BigQuery è³‡æ–™é›†	IAM Roleï¼šbq.dataViewer	ä¾å°ˆæ¡ˆè¨­å®š
API Gateway	JWT Token / OAuth	Admin / é¡§å• / ä¸€èˆ¬ä½¿ç”¨è€…
Firebase Auth	Google Sign-In	å¸³è™Ÿç™»å…¥æ§ç®¡
Dataform	GCP Service Account	Pipeline è‡ªå‹•åŒ–
LINE / Email æ¨æ’­	é™ç”¨ Server-to-Server	ä¸å…è¨±å‰ç«¯ç›´æ¥å‘¼å«

ğŸ”’ æ‰€æœ‰ API è«‹æ±‚å¿…é ˆé€é Server Proxy å±¤è™•ç†ï¼Œç¦æ­¢å‰ç«¯ç›´é€£ BigQueryã€‚

6ï¸âƒ£ æ›´æ–°é€±æœŸèˆ‡æ’ç¨‹ï¼ˆSchedule & Automationï¼‰
ç¨‹åº	æ™‚é–“	å·¥å…·	èªªæ˜
API Data Fetch	æ¯æ—¥ 02:00	Cloud Scheduler + Apps Script	æŠ“å–å„å¹³å°è³‡æ–™
Dataform ETL	æ¯æ—¥ 03:00	Dataform Job	è³‡æ–™æ¸…æ´—èˆ‡è½‰æ›
æŒ‡æ¨™æ›´æ–°	æ¯æ—¥ 04:00	BigQuery View Refresh	æ›´æ–° processed layer
Guideline ç”Ÿæˆ	æ¯é€±ä¸€ 07:30	BQML + OpenAI	ç”¢å‡º AI å»ºè­°
LINE / Email é€šçŸ¥	æ¯é€±ä¸€ 09:00	Cloud Function	å‚³é€æ‘˜è¦å ±å‘Š
7ï¸âƒ£ è¡¨æ ¼å‘½åè¦ç¯„ï¼ˆSchema Naming Conventionï¼‰
é¡å‹	å‘½åè¦å‰‡	ç¯„ä¾‹
åŸå§‹è³‡æ–™è¡¨	raw_{source}_{entity}	raw_shopline_orders
è™•ç†ä¸­è¡¨	stg_{entity}	stg_customers
è½‰æ›å¾Œè¡¨	lv0_{entity} / processed_{entity}	lv0_orders, processed_daily_summary
è¦–åœ–	view_{purpose}	view_dashboard_summary
è§¸ç™¼è¡¨	guideline_trigger	ç³»çµ±ç•°å¸¸è§¸ç™¼
å»ºè­°è¡¨	guideline_suggestions	AI è¼¸å‡ºå»ºè­°å…§å®¹
8ï¸âƒ£ è³‡æ–™å“è³ªæ§ç®¡ï¼ˆData Quality Assuranceï¼‰
æª¢æŸ¥é¡å‹	æ–¹æ³•	é æœŸçµæœ
Null æª¢æŸ¥	COUNTIF(column IS NULL)	< 1%
é‡è¤‡è¨‚å–®æª¢æŸ¥	COUNT(DISTINCT order_id) vs COUNT(*)	ç›¸ç¬¦
æ™‚å€å°é½Š	TIMESTAMP_DIFF(TW, UTC)	+8
æ¬„ä½å®Œæ•´æ€§	Schema Compare with Spec	ç„¡ç¼ºæ¼
ç•°å¸¸é€šå ±	Dataform Assert + Slack Webhook	è‡ªå‹•é€šçŸ¥
9ï¸âƒ£ ç³»çµ±ç¶­é‹èˆ‡ç›£æ§ï¼ˆMonitoring & Loggingï¼‰

ETL Logï¼šæ¯æ¬¡ Dataform åŸ·è¡Œå¯«å…¥ processed.etl_log

API Error Logï¼šCloud Logging ç›£æ§éŒ¯èª¤èˆ‡å»¶é²

Guideline Logï¼šè¨˜éŒ„æ¯æ¬¡å»ºè­°ç”Ÿæˆæ™‚é–“èˆ‡ token ç”¨é‡

ä½¿ç”¨è€…è¡Œç‚ºè¿½è¹¤ï¼šGA4 for Appï¼ˆç™»å…¥ã€æª¢è¦–ã€å»ºç«‹ä»»å‹™äº‹ä»¶ï¼‰

ğŸ”Ÿ å¾ŒçºŒæ“´å±•è€ƒé‡ï¼ˆScalability & Future Workï¼‰
é …ç›®	å»¶ä¼¸æ–¹å‘
å¤šå“ç‰Œæ¶æ§‹	å¼•å…¥ brand_id ç¶­åº¦æ–¼æ‰€æœ‰è¡¨æ ¼
å¯¦æ™‚æ›´æ–°	ä½¿ç”¨ Pub/Sub + Streaming Insert
AI æ¨¡å‹å‡ç´š	ç”± Rule-based â†’ æ··åˆå­¸ç¿’ï¼ˆHybrid Modelï¼‰
æ•¸æ“šå¯è¦–åŒ–å±¤	Looker Studio â†’ åŸç”Ÿ Recharts è¦–è¦ºå¼•æ“
å®¢æˆ¶è‡ªåŠ©æŸ¥è©¢	åŠ å…¥ SQL Playgroundï¼ˆé™é¡§å•è§’è‰²ï¼‰
âœ… æ‘˜è¦ï¼ˆExecutive Summaryï¼‰

æ•´å€‹ç³»çµ±ä»¥ BigQuery ç‚ºæ ¸å¿ƒä¸­æ¨ï¼Œ
å°‡å¤šä¾†æºè³‡æ–™æ•´åˆ â†’ æ¸…æ´— â†’ é‹ç®— â†’ AI ç”Ÿæˆ â†’ å‰ç«¯å±•ç¤º â†’ ä»»å‹™è½åœ°å½¢æˆé–‰ç’°ã€‚

ç›®æ¨™æ˜¯è®“ç‡Ÿé‹äººå“¡ç™»å…¥å¾Œï¼Œçœ‹åˆ°çš„æ¯ä¸€é …æ•¸æ“šéƒ½èƒ½è¢«ã€Œä¿¡ä»»ã€ã€æ¯ä¸€å€‹å»ºè­°éƒ½èƒ½è¢«ã€Œæ¡å–ã€ã€‚