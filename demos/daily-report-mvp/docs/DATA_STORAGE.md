# è³‡æ–™å­˜å„²ä½ç½®èªªæ˜

**å»ºç«‹æ—¥æœŸ**ï¼š2025-01-27  
**ç›®çš„**ï¼šèªªæ˜æ¯æ—¥æ•¸æ“šå½™æ•´æ—¥å ±ç³»çµ±ä½¿ç”¨çš„è³‡æ–™ä¾†æºå’Œå­˜å„²ä½ç½®

---

## ğŸ“Š è³‡æ–™å­˜å„²ç¸½è¦½

### Google Cloud å°ˆæ¡ˆ
- **å°ˆæ¡ˆ ID**ï¼š`datalake360-saintpaul`
- **ä½ç½®**ï¼š`asia-east1`ï¼ˆå°ç£ï¼‰

---

## ğŸ“ è³‡æ–™é›†çµæ§‹

### 1. datalake_stplï¼ˆä¸»è¦è³‡æ–™é›†ï¼‰

**ç”¨é€”**ï¼šå­˜å„² E-com è¨‚å–®å’Œå•†å“è³‡æ–™

**ä¸»è¦è³‡æ–™è¡¨**ï¼š

| è³‡æ–™è¡¨ | ç”¨é€” | ä½¿ç”¨æ¬„ä½ |
|--------|------|---------|
| `lv1_order_master` | è¨‚å–®ä¸»æª” | `dt`ï¼ˆæ—¥æœŸï¼‰ã€`ord_id`ï¼ˆè¨‚å–®IDï¼‰ã€`ord_rev`ï¼ˆç‡Ÿæ”¶ï¼‰ã€`bhv1`ï¼ˆè¡Œç‚ºç‹€æ…‹ï¼‰ã€`touch_class`ï¼ˆé€šè·¯ï¼‰ |
| `lv1_order` | è¨‚å–®æ˜ç´° | è¨‚å–®å•†å“æ˜ç´° |
| `lv1_user` | ç”¨æˆ¶è³‡æ–™ | æœƒå“¡è³‡è¨Š |
| `lv1_product` | å•†å“è³‡æ–™ | å•†å“è³‡è¨Š |

**æŸ¥è©¢ç¯„ä¾‹**ï¼š
```sql
SELECT 
    SUM(CASE WHEN bhv1 <> 'å–æ¶ˆ' THEN ord_rev ELSE 0 END) as revenue,
    COUNT(DISTINCT CASE WHEN bhv1 <> 'å–æ¶ˆ' THEN ord_id END) as orders
FROM `datalake360-saintpaul.datalake_stpl.lv1_order_master`
WHERE DATE(dt) = DATE('2025-11-04')
    AND touch_class = 'ec'
```

---

### 2. analytics_304437305ï¼ˆGA4 è³‡æ–™é›†ï¼‰

**ç”¨é€”**ï¼šå­˜å„² Google Analytics 4 äº‹ä»¶è³‡æ–™

**ä¸»è¦è³‡æ–™è¡¨**ï¼š

| è³‡æ–™è¡¨ | ç”¨é€” | çµæ§‹ |
|--------|------|------|
| `events_*` | GA4 äº‹ä»¶è¡¨ï¼ˆæ—¥æœŸåˆ†å€ï¼‰ | æ¯æ—¥ä¸€å€‹åˆ†å€è¡¨ï¼ˆæ ¼å¼ï¼š`events_YYYYMMDD`ï¼‰ |

**æŸ¥è©¢ç¯„ä¾‹**ï¼š
```sql
SELECT
    COUNT(DISTINCT CONCAT(
        user_pseudo_id,
        '-',
        COALESCE(
            CAST((SELECT value.int_value FROM UNNEST(event_params) WHERE key = 'ga_session_id') AS STRING),
            CAST((SELECT value.string_value FROM UNNEST(event_params) WHERE key = 'session_id') AS STRING),
            ''
        )
    )) as sessions
FROM `datalake360-saintpaul.analytics_304437305.events_*`
WHERE _TABLE_SUFFIX = '20251104'
    AND event_name = 'session_start'
```

---

### 3. å…¶ä»–è³‡æ–™é›†

| è³‡æ–™é›† | ç”¨é€” | ç‹€æ…‹ |
|--------|------|------|
| `cdp_data` | CDP ç›¸é—œè³‡æ–™ | å­˜åœ¨ï¼Œä½†æœªä½¿ç”¨ |
| `saintpaul_data` | å…¶ä»–è³‡æ–™ | å­˜åœ¨ï¼Œä½†æœªä½¿ç”¨ |
| `datalake_temp_stpl` | è‡¨æ™‚è³‡æ–™ | å­˜åœ¨ï¼Œä½†æœªä½¿ç”¨ |

---

## ğŸ” è³‡æ–™æµç¨‹

### è³‡æ–™ä¾†æº â†’ è³‡æ–™å­˜å„² â†’ æŸ¥è©¢ä½¿ç”¨

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    è³‡æ–™ä¾†æº                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ Shopline/Cyberbiz å¾Œå°                               â”‚
â”‚  â€¢ GA4 äº‹ä»¶è¿½è¹¤                                         â”‚
â”‚  â€¢ Meta Adsï¼ˆæœªä¾† MCP æ•´åˆï¼‰                            â”‚
â”‚  â€¢ Google Adsï¼ˆæœªä¾† MCP æ•´åˆï¼‰                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              BigQuery è³‡æ–™å€‰å„²                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ datalake_stpl.lv1_order_master  â† E-com è¨‚å–®        â”‚
â”‚  â€¢ analytics_304437305.events_*     â† GA4 äº‹ä»¶          â”‚
â”‚  â€¢ ï¼ˆå¾…å»ºç«‹ï¼‰å»£å‘Šè³‡æ–™è¡¨                â† å»£å‘Šè³‡æ–™        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           æ¯æ—¥æ•¸æ“šå½™æ•´æ—¥å ±ç³»çµ±                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ DataFetcher æŸ¥è©¢ BigQuery                           â”‚
â”‚  â€¢ ç”Ÿæˆå–®è¡Œ JSON è³‡æ–™                                   â”‚
â”‚  â€¢ æ¨é€åˆ° Google Chat                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“‹ è³‡æ–™è¡¨è©³ç´°èªªæ˜

### lv1_order_masterï¼ˆè¨‚å–®ä¸»æª”ï¼‰

**ç”¨é€”**ï¼šæ¯æ—¥æŸ¥è©¢ç‡Ÿæ”¶ã€è¨‚å–®æ•¸ã€AOV

**é—œéµæ¬„ä½**ï¼š
- `dt`ï¼šè¨‚å–®æ—¥æœŸï¼ˆTIMESTAMPï¼‰
- `ord_id`ï¼šè¨‚å–® IDï¼ˆSTRINGï¼‰
- `ord_rev`ï¼šè¨‚å–®é‡‘é¡ï¼ˆFLOATï¼‰
- `bhv1`ï¼šè¡Œç‚ºç‹€æ…‹ï¼ˆSTRINGï¼Œä¾‹å¦‚ï¼šã€Œå–æ¶ˆã€ï¼‰
- `touch_class`ï¼šé€šè·¯é¡åˆ¥ï¼ˆSTRINGï¼Œä¾‹å¦‚ï¼šã€Œecã€ï¼‰
- `user_id`ï¼šç”¨æˆ¶ IDï¼ˆSTRINGï¼‰

**æŸ¥è©¢é‚è¼¯**ï¼š
- æ’é™¤å–æ¶ˆè¨‚å–®ï¼š`bhv1 <> 'å–æ¶ˆ'`
- åªæŸ¥è©¢é›»å•†é€šè·¯ï¼š`touch_class = 'ec'`
- æŒ‰æ—¥æœŸç¯©é¸ï¼š`DATE(dt) = DATE('YYYY-MM-DD')`

---

### events_*ï¼ˆGA4 äº‹ä»¶è¡¨ï¼‰

**ç”¨é€”**ï¼šæ¯æ—¥æŸ¥è©¢ Sessionsã€è½‰æ›äº‹ä»¶

**é—œéµæ¬„ä½**ï¼š
- `event_name`ï¼šäº‹ä»¶åç¨±ï¼ˆSTRINGï¼Œä¾‹å¦‚ï¼šã€Œsession_startã€ã€ã€Œpurchaseã€ï¼‰
- `user_pseudo_id`ï¼šç”¨æˆ¶ IDï¼ˆSTRINGï¼‰
- `event_params`ï¼šäº‹ä»¶åƒæ•¸ï¼ˆARRAYï¼ŒåŒ…å« `ga_session_id`ã€`transaction_id` ç­‰ï¼‰
- `_TABLE_SUFFIX`ï¼šæ—¥æœŸåˆ†å€ï¼ˆSTRINGï¼Œæ ¼å¼ï¼š`YYYYMMDD`ï¼‰

**æŸ¥è©¢é‚è¼¯**ï¼š
- ä½¿ç”¨æ—¥æœŸåˆ†å€ï¼š`_TABLE_SUFFIX = 'YYYYMMDD'`
- Sessions æŸ¥è©¢ï¼š`event_name = 'session_start'`
- Purchase æŸ¥è©¢ï¼š`event_name = 'purchase'` ä¸¦å–å¾— `transaction_id`

---

## ğŸ”„ è³‡æ–™æ›´æ–°é »ç‡

| è³‡æ–™ä¾†æº | æ›´æ–°é »ç‡ | æ›´æ–°æ™‚é–“ | å‚™è¨» |
|---------|---------|---------|------|
| E-com è¨‚å–® | æ¯æ—¥ | è‡ªå‹•åŒæ­¥ | ç”±è³‡æ–™ç®¡é“è‡ªå‹•åŒ¯å…¥ |
| GA4 äº‹ä»¶ | æ¯æ—¥ | è‡ªå‹•åŒæ­¥ | GA4 Export è‡ªå‹•åŒ¯å…¥ |
| å»£å‘Šè³‡æ–™ | å¾…å»ºç«‹ | å¾…å»ºç«‹ | æœªä¾†ä½¿ç”¨ MCP å–å¾— |

---

## ğŸ“Š è³‡æ–™æŸ¥è©¢ä½ç½®

### ç¨‹å¼ç¢¼ä½ç½®

**è³‡æ–™æŸ¥è©¢é‚è¼¯**ï¼š
- `src/data/fetcher.py` - ä¸»è¦æŸ¥è©¢é‚è¼¯
  - `fetch_daily_metrics()` - æŸ¥è©¢ E-com è¨‚å–®è³‡æ–™
  - `fetch_ga4_sessions()` - æŸ¥è©¢ GA4 Sessions
  - `fetch_cvr()` - è¨ˆç®—è½‰æ›ç‡
  - `fetch_mtd_metrics()` - æŸ¥è©¢æœˆè¿„ä»Šè³‡æ–™

**BigQuery é…ç½®**ï¼š
- `config/bigquery.py` - BigQuery é€£ç·šè¨­å®š
  - `project_id`: `datalake360-saintpaul`
  - `dataset_id`: `datalake_stpl`
  - `ga4_dataset`: `analytics_304437305`

---

## ğŸ” è³‡æ–™é©—è­‰

### æª¢æŸ¥è³‡æ–™æ˜¯å¦å­˜åœ¨

```python
from google.cloud import bigquery
client = bigquery.Client(project='datalake360-saintpaul')

# æª¢æŸ¥è³‡æ–™è¡¨
tables = list(client.list_tables('datalake_stpl'))
print([t.table_id for t in tables])

# æª¢æŸ¥ GA4 è³‡æ–™
ga4_tables = list(client.list_tables('analytics_304437305'))
print([t.table_id for t in ga4_tables])
```

---

## ğŸ“ è³‡æ–™è¡¨çµæ§‹åƒè€ƒ

### lv1_order_master çµæ§‹ï¼ˆéƒ¨åˆ†ï¼‰

```sql
CREATE TABLE `datalake360-saintpaul.datalake_stpl.lv1_order_master` (
    dt TIMESTAMP,
    ord_id STRING,
    ord_rev FLOAT,
    bhv1 STRING,
    touch_class STRING,
    user_id STRING,
    -- ... å…¶ä»–æ¬„ä½
)
```

### events_* çµæ§‹ï¼ˆGA4 æ¨™æº–ï¼‰

```sql
-- GA4 äº‹ä»¶è¡¨æ˜¯ Google è‡ªå‹•åŒ¯å‡ºçš„æ¨™æº–æ ¼å¼
-- åŒ…å«ï¼ševent_name, user_pseudo_id, event_params, _TABLE_SUFFIX ç­‰
```

---

## ğŸ¯ æœªä¾†æ“´å……

### å»£å‘Šè³‡æ–™å­˜å„²ï¼ˆè¦åŠƒä¸­ï¼‰

**é¸é … Aï¼šå»ºç«‹æ–°çš„è³‡æ–™è¡¨**
- è³‡æ–™é›†ï¼š`datalake_stpl` æˆ–æ–°å»º `ad_data`
- è³‡æ–™è¡¨ï¼š`meta_ads_daily`ã€`google_ads_daily`
- æ›´æ–°æ–¹å¼ï¼šMCP è‡ªå‹•åŒ¯å…¥

**é¸é … Bï¼šä½¿ç”¨ç¾æœ‰è¡¨**
- å¦‚æœå·²æœ‰æ•´åˆè¡¨ï¼Œç›´æ¥ä½¿ç”¨
- éœ€è¦ç¢ºèªè¡¨çµæ§‹å’Œæ¬„ä½

---

## ğŸ“š ç›¸é—œæ–‡æª”

- [BigQuery é…ç½®èªªæ˜](../weekly-report-generator/docs/technical/CONFIGURATION_SUMMARY.md)
- [è³‡æ–™åº«çµæ§‹èªªæ˜](../weekly-report-generator/docs/technical/DATABASE_SCHEMA.md)
- [MCP æ•´åˆè¦åŠƒ](./MCP_INTEGRATION_PLAN.md)

---

**æœ€å¾Œæ›´æ–°**ï¼š2025-01-27

