<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ•¸æ“šåˆ†æ - AI ç‡Ÿé‹é¡§å•ç³»çµ±</title>
  
  <!-- CSS -->
  <link rel="stylesheet" href="css/main.css">
  <link rel="stylesheet" href="css/components.css">
  <link rel="stylesheet" href="css/navigation.css">
  <link rel="stylesheet" href="css/dashboard.css">
  <link rel="stylesheet" href="css/data.css">
</head>
<body>
  <!-- ä¸»å°èˆªæ¬„ -->
  <nav class="main-navigation">
    <div class="nav-container">
      <div class="nav-left">
        <a href="dashboard.html" class="nav-logo">
          AI ç‡Ÿé‹é¡§å•
        </a>
        <div class="nav-menu">
          <div class="nav-item">
            <a href="dashboard.html" class="nav-link" id="nav-dashboard" data-page="dashboard">
              <span class="nav-text">Dashboard</span>
            </a>
          </div>
          <div class="nav-item">
            <a href="data.html" class="nav-link active" id="nav-data" data-page="data">
              <span class="nav-text">æ•¸æ“šåˆ†æ</span>
            </a>
          </div>
          <div class="nav-item">
            <a href="insights.html" class="nav-link" id="nav-insights" data-page="insights">
              <span class="nav-text">æ´å¯Ÿä¸­å¿ƒ</span>
            </a>
          </div>
          <div class="nav-item">
            <a href="actions.html" class="nav-link" id="nav-actions" data-page="actions">
              <span class="nav-text">è¡Œå‹•æ–¹æ¡ˆ</span>
            </a>
          </div>
          <div class="nav-item">
            <a href="consultants.html" class="nav-link" id="nav-consultants" data-page="consultants">
              <span class="nav-text">è§’è‰²/é¡§å•</span>
            </a>
          </div>
          <div class="nav-item">
            <a href="reports.html" class="nav-link" id="nav-reports" data-page="reports">
              <span class="nav-text">å ±å‘Š</span>
            </a>
          </div>
          <div class="nav-item">
            <a href="settings.html" class="nav-link" id="nav-settings" data-page="settings">
              <span class="nav-text">è¨­å®š</span>
            </a>
          </div>
        </div>
      </div>
      <div class="nav-right">
        <div class="brand-selector-nav">
          <select class="brand-select-nav" id="brandSelectNav">
            <option>å“ç‰Œï¼šè±†æ²¹ä¼¯</option>
          </select>
        </div>
        <div class="user-menu-nav">
          <div class="user-avatar-nav">ğŸ‘¤</div>
          <span class="user-email-nav" id="userEmailNav">demo@reddoor.com</span>
        </div>
      </div>
    </div>
  </nav>

  <!-- é é¢æ¨™é¡Œ -->
  <section class="page-header-section">
    <div class="page-header-content">
      <h1 class="page-title">æ•¸æ“šåˆ†æ</h1>
      <p class="page-subtitle">å¯ drill-down çš„ä¸»é¡Œå¼æ•¸æ“šåˆ†æï¼Œæ·±å…¥æ¢ç´¢ GMV æ‹†è§£èˆ‡å¤šç¶­åº¦æŒ‡æ¨™</p>
    </div>
  </section>

  <!-- ä¸»è¦å…§å®¹ -->
  <main class="main-content data-main">
    <div class="container data-summary-section">
      <div class="data-summary-header">
        <div>
          <h2>GMV åŸºæœ¬æŒ‡æ¨™å…¬å¼</h2>
          <p id="dataRangeLabel">æœ€è¿‘ 7 å¤© Â· èˆ‡ä¸Šé€±åŒæœŸæ¯”è¼ƒ</p>
        </div>
        <div class="data-summary-controls">
          <label for="dataRangeSelect" class="sr-only">é¸æ“‡æ™‚é–“å€é–“</label>
          <select class="form-input" id="dataRangeSelect">
            <option value="7d">æœ€è¿‘ 7 å¤©</option>
            <option value="yesterday">æ˜¨å¤©</option>
            <option value="30d">æœ€è¿‘ 30 å¤©</option>
            <option value="custom">è‡ªè¨‚ç¯„åœ</option>
          </select>
          <button class="btn btn-secondary btn-sm" id="dataCustomRangeBtn" type="button">è‡ªè¨‚æ—¥æœŸ</button>
        </div>
      </div>

      <div class="data-summary-grid">
        <article class="data-revenue-panel data-kpi-card" id="dataRevenuePanel">
          <div class="revenue-card revenue-card--net">
            <div class="revenue-card-header">
              <span class="revenue-title">æˆäº¤ç‡Ÿæ”¶ï¼ˆæˆäº¤é‡‘é¡ï¼‰</span>
              <span class="revenue-note">å«å·²å®Œæˆè¨‚å–®å¯¦æ”¶é‡‘é¡</span>
            </div>
            <div class="revenue-value" id="netRevenueValue">--</div>
            <div class="revenue-substats">
              <span id="netOrderCount">æˆäº¤è¨‚å–®æ•¸ -- ç­†</span>
            </div>
          </div>
          <div class="revenue-card revenue-card--gross">
            <div class="revenue-card-header">
              <span class="revenue-title">ç¸½ç‡Ÿæ¥­é¡</span>
              <span class="revenue-note">æœªæ‰£é™¤å–æ¶ˆ/é€€å–®é‡‘é¡</span>
            </div>
            <div class="revenue-value" id="grossRevenueValue">--</div>
            <div class="revenue-substats">
              <span id="grossOrderCount">ç¸½è¨‚å–®æ•¸ -- ç­†</span>
            </div>
          </div>
          <div class="revenue-footer">
            <div class="cancel-metric">
              <span class="cancel-label">å–æ¶ˆç‡</span>
              <div class="cancel-progress">
                <div class="cancel-progress-bar" id="cancelProgressBar"></div>
              </div>
              <span class="cancel-value" id="cancelRateValue">--</span>
            </div>
            <div class="revenue-formula">
              <span class="formula-label">GMV æŒ‡æ¨™å…¬å¼</span>
              <span class="formula-text">å·¥ä½œéšæ®µ Ã— è½‰æ›ç‡ Ã— å¹³å‡è¨‚å–®é‡‘é¡</span>
            </div>
          </div>
        </article>
        <article class="data-kpi-card" id="dataSnapshotCard">
          <h3>æœ¬é€±é—œéµæ‘˜è¦</h3>
          <div class="data-kpi-meta" id="dataSnapshotList"></div>
          <section>
            <h4 style="font-size:0.95rem;color:var(--color-gray-600);margin:8px 0 4px;">AI æ´å¯Ÿç„¦é»</h4>
            <ul class="anomaly-list" id="dataSnapshotInsights"></ul>
          </section>
        </article>
      </div>
    </div>

    <div class="container data-module-stack">
      <section class="data-module data-module--traffic" id="trafficModule">
        <header class="data-module-header">
          <h2>æµé‡åˆ†æ</h2>
          <div class="data-module-controls" id="trafficSourceControls">
            <button class="pill-button active" data-traffic-source="direct">ç›´æ¥æµé‡</button>
            <button class="pill-button" data-traffic-source="ads">ä»˜è²»å»£å‘Š</button>
            <button class="pill-button" data-traffic-source="member">æœƒå“¡ç¶“ç‡Ÿ</button>
            <button class="pill-button" data-traffic-source="ai">AI ä¾†æº</button>
            <button class="pill-button" data-traffic-source="organic">è‡ªç„¶æœå°‹</button>
            <button class="pill-button" data-traffic-source="social">ç¤¾ç¾¤ç¶“ç‡Ÿ</button>
            <button class="pill-button" data-traffic-source="referral">åƒç…§é€£çµ</button>
            <button class="pill-button" data-traffic-source="other">å…¶ä»–</button>
          </div>
        </header>
        <div class="data-module-grid data-module-grid--traffic">
          <article class="module-card module-card--stat" id="trafficSessionsCard">
            <h3>Sessions</h3>
            <div class="stat-value" id="trafficSessionsValue">--</div>
            <p class="stat-desc" id="trafficSessionsDesc">ç­‰å¾…è³‡æ–™...</p>
          </article>
          <article class="module-card module-card--stat" id="trafficAovCard">
            <h3>å¹³å‡è¨‚å–®é‡‘é¡</h3>
            <div class="stat-value" id="trafficAovValue">--</div>
            <p class="stat-desc" id="trafficAovDesc">ç­‰å¾…è³‡æ–™...</p>
          </article>
          <article class="module-card module-card--stat" id="trafficCvrCard">
            <h3>è½‰æ›ç‡</h3>
            <div class="stat-value" id="trafficCvrValue">--</div>
            <p class="stat-desc" id="trafficCvrDesc">ç­‰å¾…è³‡æ–™...</p>
          </article>
        </div>
        <div class="data-ai-insight" id="trafficAiInsight">
          <h3>AI æ´å¯Ÿåˆ†æ</h3>
          <ul class="recommendation-list" id="trafficAiInsightList">
            <li>ç­‰å¾…è³‡æ–™...</li>
          </ul>
        </div>
      </section>

      <section class="data-module data-module--aov" id="aovModule">
        <header class="data-module-header">
          <h2>å¹³å‡è¨‚å–®é‡‘é¡åˆ†æ</h2>
          <div class="data-module-controls">
            <button class="pill-button active" data-aov-dimension="overall">æ•´é«”</button>
            <button class="pill-button" data-aov-dimension="new">æ–°å®¢</button>
            <button class="pill-button" data-aov-dimension="returning">å›è³¼å®¢</button>
          </div>
        </header>
        <div class="data-module-grid data-module-grid--aov">
          <article class="module-card chart-card" id="aovCartCard">
            <div class="chart-header">
              <div>
                <h3>è³¼ç‰©è»Šä»¶æ•¸åˆ†å¸ƒ</h3>
                <p class="chart-subtitle" id="aovCartSubtitle">æ•´é«” Â· ä»¶æ•¸çµæ§‹</p>
              </div>
              <span class="chart-note">é¡¯ç¤ºå„ä»¶æ•¸ä½”æ¯”èˆ‡å¹³å‡è¨‚å–®é‡‘é¡</span>
            </div>
            <div class="chart-bar-list" id="aovCartList"></div>
          </article>
          <article class="module-card chart-card" id="aovPriceBandCard">
            <div class="chart-header">
              <div>
                <h3>åƒ¹æ ¼å¸¶çµæ§‹</h3>
                <p class="chart-subtitle" id="aovPriceSubtitle">æ•´é«” Â· å–®åƒ¹çµ„æˆ</p>
              </div>
              <span class="chart-note">å€åˆ†é«˜/ä¸­/ä½åƒ¹æ ¼å¸¶çš„è¨‚å–®å æ¯”</span>
            </div>
            <div class="chart-bar-list chart-bar-list--stack" id="aovPriceList"></div>
          </article>
        </div>
        <div class="data-ai-insight" id="aovAiInsight">
          <h3>AI æ´å¯Ÿåˆ†æ</h3>
          <ul class="recommendation-list" id="aovAiInsightList">
            <li>ç­‰å¾…è³‡æ–™...</li>
          </ul>
        </div>
      </section>

      <section class="data-module data-module--funnel" id="funnelModule">
        <header class="data-module-header">
          <h2>è½‰æ›ç‡æ¼æ–—åˆ†æ</h2>
          <div class="data-module-controls">
            <button class="pill-button active" data-funnel-range="7d">æœ€è¿‘ 7 å¤©</button>
            <button class="pill-button" data-funnel-range="30d">æœ€è¿‘ 30 å¤©</button>
            <button class="pill-button" data-funnel-range="90d">æœ€è¿‘ 90 å¤©</button>
          </div>
        </header>
        <div class="data-module-grid data-module-grid--funnel">
          <article class="module-card chart-card funnel-side" id="productFunnelCard">
            <div class="chart-header">
              <div>
                <h3>å•†å“åˆ†å€</h3>
                <p class="chart-subtitle" id="productFunnelSubtitle">Top å•†å“æ¼æ–—</p>
              </div>
              <div class="chart-tabs">
                <button class="pill-button active" data-product-segment="topProducts">Top å•†å“</button>
                <button class="pill-button" data-product-segment="categories">å•†å“é¡åˆ¥</button>
              </div>
            </div>
            <div class="mini-funnel-list" id="productFunnelList"></div>
          </article>
          <article class="module-card funnel-main" id="mainFunnelCard">
            <div class="chart-header">
              <div>
                <h3>å…¨ç«™æ¼æ–—</h3>
                <p class="chart-subtitle" id="mainFunnelSubtitle">æœ€è¿‘ 7 å¤© Â· GA4 æ¨™æº–äº‹ä»¶</p>
              </div>
              <span class="chart-note">å¾è¨ªå®¢åˆ°æˆäº¤çš„æ ¸å¿ƒè½‰æ›ç‡</span>
            </div>
            <div class="funnel-visual" id="mainFunnelVisual"></div>
          </article>
          <article class="module-card chart-card funnel-side" id="campaignFunnelCard">
            <div class="chart-header">
              <div>
                <h3>æ´»å‹•åˆ†å€</h3>
                <p class="chart-subtitle" id="campaignFunnelSubtitle">æ´»å‹•è¡¨ç¾æ¼æ–—</p>
              </div>
              <div class="chart-tabs">
                <button class="pill-button active" data-activity-segment="campaigns">ç†±é–€æ´»å‹•</button>
                <button class="pill-button" data-activity-segment="channels">æ¨å»£æ¸ é“</button>
              </div>
            </div>
            <div class="mini-funnel-list" id="campaignFunnelList"></div>
          </article>
        </div>
        <div class="data-ai-insight" id="funnelAiInsight">
          <h3>AI æ´å¯Ÿåˆ†æ</h3>
          <ul class="recommendation-list" id="funnelAiInsightList">
            <li>ç­‰å¾…è³‡æ–™...</li>
          </ul>
        </div>
      </section>

      <div class="data-export">
        <button class="btn btn-secondary btn-sm" id="dataExportBtn" type="button">åŒ¯å‡ºå ±è¡¨ï¼ˆå³å°‡æ¨å‡ºï¼‰</button>
      </div>
    </div>
  </main>

  <!-- JavaScript -->
  <script src="js/mockData.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/navigation.js"></script>
  <script>
    (function () {
      if (!window.mockData || !window.utils) return;

      const summary = mockData.summary;
      const kpi = mockData.kpiPyramid;
      const guidelines = mockData.guidelines || [];
      const tasks = mockData.tasks || [];
      const trafficSources = mockData.trafficSources || [];

      const setText = (id, value) => {
        const el = document.getElementById(id);
        if (el) el.textContent = value;
      };

      const formatChange = (change) => `${change >= 0 ? 'â†‘' : 'â†“'} ${Math.abs(change)}%`;

      const dataRangeLabel = document.getElementById('dataRangeLabel');
      if (dataRangeLabel) {
        dataRangeLabel.textContent = `${summary.dateRange} Â· èˆ‡ä¸Šé€± (${summary.previousWeek}) æ¯”è¼ƒ`;
      }

      // === ç‡Ÿæ”¶èˆ‡è¨‚å–®ç¸½è¦½ ===
      const marketingSpend = 123674;
      const cancellationRate = 14.54;
      const grossRevenue = summary.revenue / (1 - cancellationRate / 100);
      const refundAmount = grossRevenue - summary.revenue;
      const orderCount = kpi.aov.value > 0 ? Math.round(summary.revenue / kpi.aov.value) : 0;
      const totalOrders = Math.round(orderCount / (1 - cancellationRate / 100));
      const cancelledOrders = Math.max(totalOrders - orderCount, 0);
      const roas = marketingSpend > 0 ? (summary.revenue / marketingSpend).toFixed(2) : 'â€”';

      setText('netRevenueValue', utils.formatCurrency(Math.round(summary.revenue)));
      setText('netOrderCount', `æˆäº¤è¨‚å–®æ•¸ ${utils.formatNumber(orderCount)} ç­†`);
      setText('grossRevenueValue', utils.formatCurrency(Math.round(grossRevenue)));
      setText('grossOrderCount', `ç¸½è¨‚å–®æ•¸ ${utils.formatNumber(totalOrders)} ç­†`);

      const cancelRateValue = document.getElementById('cancelRateValue');
      if (cancelRateValue) {
        cancelRateValue.textContent = `${cancellationRate.toFixed(2)}%ï¼ˆ${utils.formatNumber(cancelledOrders)} ç­†ï¼‰`;
      }

      const cancelProgressBar = document.getElementById('cancelProgressBar');
      if (cancelProgressBar) {
        cancelProgressBar.style.width = `${Math.min(cancellationRate, 100)}%`;
      }

      const snapshotList = document.getElementById('dataSnapshotList');
      if (snapshotList) {
        const snapshotItems = [
          { label: 'ç‡Ÿæ”¶è®ŠåŒ–', value: formatChange(summary.revenueChange) },
          { label: 'æµé‡è®ŠåŒ–', value: formatChange(kpi.traffic.change) },
          { label: 'è½‰æ›ç‡è®ŠåŒ–', value: formatChange(kpi.conversion.change) },
          { label: 'å®¢å–®åƒ¹è®ŠåŒ–', value: formatChange(kpi.aov.change) },
          { label: 'è¨‚å–®ç­†æ•¸', value: utils.formatNumber(orderCount) },
          { label: 'å–æ¶ˆé€€è²¨é‡‘é¡', value: utils.formatCurrency(Math.round(refundAmount)) },
          { label: 'è¡ŒéŠ·èŠ±è²»', value: utils.formatCurrency(marketingSpend) },
          { label: 'ROAS', value: roas },
          { label: 'å–æ¶ˆç‡', value: `${cancellationRate.toFixed(2)}%` }
        ];
        snapshotList.innerHTML = snapshotItems.map(item => `
          <div class="meta-item">
            <span class="meta-label">${item.label}</span>
            <span class="meta-value">${item.value}</span>
          </div>
        `).join('');
      }

      const snapshotInsights = document.getElementById('dataSnapshotInsights');
      if (snapshotInsights) {
        const topInsights = guidelines.slice(0, 3);
        snapshotInsights.innerHTML = topInsights.length
          ? topInsights.map(g => `<li><strong>${g.category}ï½œ${g.source}</strong>ï¼š${g.insight}</li>`).join('')
          : '<li>ç›®å‰æ²’æœ‰åµæ¸¬åˆ°ç•°å¸¸æŒ‡æ¨™ï¼Œç‡Ÿé‹ç‹€æ³ç©©å®šã€‚</li>';
      }

      // === æµé‡åˆ†æ ===
      const totalTrafficSessions = trafficSources.reduce((sum, item) => sum + item.sessions, 0);
      const trafficCategoryMap = {
        direct: { label: 'ç›´æ¥æµé‡', sources: ['ç›´æ¥'] },
        ads: { label: 'ä»˜è²»å»£å‘Š', sources: ['å»£å‘Š'] },
        member: { label: 'æœƒå“¡ç¶“ç‡Ÿ', sources: ['Email'] },
        ai: { label: 'AI ä¾†æº', sources: ['AI'] },
        organic: { label: 'è‡ªç„¶æœå°‹', sources: ['æœå°‹'] },
        social: { label: 'ç¤¾ç¾¤ç¶“ç‡Ÿ', sources: ['ç¤¾ç¾¤'] },
        referral: { label: 'åƒç…§é€£çµ', sources: ['æ¨è–¦'] },
        other: { label: 'å…¶ä»–', sources: ['å…¶ä»–'] }
      };

      const renderInsightList = (container, guideList, taskList, emptyMessage) => {
        if (!container) return;
        const items = [];
        guideList.forEach(g => {
          const insightText = g.insight ? `${g.insight}ã€‚` : '';
          const suggestionText = g.suggestion || 'å»ºè­°æŒçºŒè§€å¯Ÿã€‚';
          items.push(`<li><strong>AI æ´å¯Ÿï¼š</strong>${insightText}<span class="insight-suggestion">å»ºè­°ï¼š${suggestionText}</span></li>`);
        });
        taskList.forEach(t => items.push(`<li><strong>ä»»å‹™ï¼š</strong>${t.title} â€” ${t.description}</li>`));
        container.innerHTML = items.length ? items.join('') : `<li>${emptyMessage}</li>`;
      };

      const updateTrafficModule = (categoryKey) => {
        const config = trafficCategoryMap[categoryKey] || trafficCategoryMap.direct;
        const selectedSources = trafficSources.filter(src => config.sources.includes(src.source));

        const totalSessions = selectedSources.reduce((sum, src) => sum + src.sessions, 0);
        const totalRevenue = selectedSources.reduce((sum, src) => sum + src.revenue, 0);
        const totalChange = selectedSources.reduce((sum, src) => sum + (src.change || 0) * src.sessions, 0);
        const totalOrders = selectedSources.reduce((sum, src) => {
          const orders = src.aov > 0 ? src.revenue / src.aov : 0;
          return sum + orders;
        }, 0);
        const avgAov = totalOrders > 0 ? totalRevenue / totalOrders : 0;
        const avgCvr = totalSessions > 0 ? selectedSources.reduce((sum, src) => sum + (src.cvr || 0) * src.sessions, 0) / totalSessions : 0;
        const share = totalTrafficSessions > 0 ? ((totalSessions / totalTrafficSessions) * 100).toFixed(1) : '0.0';
        const avgChange = totalSessions > 0 ? totalChange / totalSessions : 0;
        const totalConversions = Math.round(totalSessions * (avgCvr / 100));

        setText('trafficSessionsValue', totalSessions ? utils.formatNumber(totalSessions) : '--');
        setText('trafficSessionsDesc', totalSessions ? `ä½”ç¸½æµé‡ ${share}% Â· è®ŠåŒ– ${formatChange(avgChange)}` : 'å°šç„¡è³‡æ–™');

        setText('trafficAovValue', totalRevenue ? utils.formatCurrency(Math.round(avgAov)) : '--');
        setText('trafficAovDesc', totalRevenue ? `ç´¯è¨ˆç‡Ÿæ”¶ ${utils.formatCurrency(Math.round(totalRevenue))}` : 'å°šç„¡è³‡æ–™');

        setText('trafficCvrValue', totalSessions ? `${avgCvr.toFixed(2)}%` : '--');
        setText('trafficCvrDesc', totalSessions ? `é ä¼°è½‰æ›è¨‚å–® ${utils.formatNumber(totalConversions)}` : 'å°šç„¡è³‡æ–™');

        const trafficAiList = document.getElementById('trafficAiInsightList');
        if (trafficAiList) {
          const relatedGuidelines = guidelines.filter(g => g.category.includes('æµé‡') || config.sources.some(name => g.source.includes(name)));
          const relatedTasks = tasks.filter(t => t.category === 'æµé‡' || t.category === 'å»£å‘Š');
          renderInsightList(trafficAiList, relatedGuidelines, relatedTasks, 'ç›®å‰æ²’æœ‰ç›¸é—œ AI æ´å¯Ÿï¼Œè«‹æŒçºŒè§€å¯Ÿã€‚');
        }
      };

      const trafficButtons = document.querySelectorAll('[data-traffic-source]');
      trafficButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          trafficButtons.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          updateTrafficModule(btn.dataset.trafficSource);
        });
      });

      const defaultTrafficKey = document.querySelector('[data-traffic-source].active')?.dataset.trafficSource || 'direct';
      updateTrafficModule(defaultTrafficKey);

      // === å¹³å‡è¨‚å–®é‡‘é¡åˆ†æ ===
      const aovAnalysis = mockData.aovAnalysis || {};
      const aovSegments = aovAnalysis.segments || {};
      const aovExtraInsights = aovAnalysis.insights || [];

      /**
       * æ¸²æŸ“å¹³å‡è¨‚å–®é‡‘é¡å€å¡Šï¼ˆè³¼ç‰©è»Šä»¶æ•¸åˆ†å¸ƒèˆ‡åƒ¹æ ¼å¸¶çµæ§‹ï¼‰
       * @param {string} segmentKey ç›®å‰é¸å–çš„å®¢ç¾¤ä»£ç¢¼ï¼ˆoverall/new/returningï¼‰
       */
      const updateAovModule = (segmentKey) => {
        const segment = aovSegments[segmentKey] || aovSegments.overall;
        if (!segment) return;

        const cartList = document.getElementById('aovCartList');
        const priceList = document.getElementById('aovPriceList');
        const cartSubtitle = document.getElementById('aovCartSubtitle');
        const priceSubtitle = document.getElementById('aovPriceSubtitle');

        if (cartSubtitle) {
          cartSubtitle.textContent = `${segment.label} Â· ä»¶æ•¸çµæ§‹`;
        }

        if (priceSubtitle) {
          priceSubtitle.textContent = `${segment.label} Â· å–®åƒ¹çµ„æˆ`;
        }

        if (cartList) {
          cartList.innerHTML = (segment.cartDistribution || []).map(item => {
            const share = Number(item.share || 0);
            const avg = item.avgValue ? utils.formatCurrency(item.avgValue) : 'â€”';
            return `
              <div class="chart-bar-row">
                <div class="chart-bar-label">
                  <span class="label-main">${item.label}</span>
                  <span class="label-sub">å¹³å‡è¨‚å–®é‡‘é¡ ${avg}</span>
                </div>
                <div class="chart-bar-track" role="presentation" aria-hidden="true">
                  <div class="chart-bar-fill" style="width: ${Math.min(Math.max(share, 0), 100)}%;"></div>
                </div>
                <span class="chart-bar-value">${share.toFixed(0)}%</span>
              </div>
            `;
          }).join('');
        }

        if (priceList) {
          priceList.innerHTML = (segment.priceBands || []).map(item => {
            const share = Number(item.share || 0);
            const avg = item.avgOrderValue ? utils.formatCurrency(item.avgOrderValue) : 'â€”';
            return `
              <div class="chart-bar-row">
                <div class="chart-bar-label">
                  <span class="label-main">${item.label}</span>
                  <span class="label-sub">å¹³å‡è¨‚å–®é‡‘é¡ ${avg}</span>
                </div>
                <div class="chart-bar-track" role="presentation" aria-hidden="true">
                  <div class="chart-bar-fill" style="width: ${Math.min(Math.max(share, 0), 100)}%;"></div>
                </div>
                <span class="chart-bar-value">${share.toFixed(0)}%</span>
              </div>
            `;
          }).join('');
        }

        const aovAiInsightList = document.getElementById('aovAiInsightList');
        if (aovAiInsightList) {
          const aovGuidelines = guidelines.filter(g => g.category.includes('å®¢å–®åƒ¹'));
          const aovTasks = tasks.filter(t => t.category === 'å®¢å–®åƒ¹');
          const extra = aovExtraInsights.filter(item => item.segment === segmentKey || item.segment === 'overall');

          const insightItems = [];

          extra.forEach(item => {
            insightItems.push(`<li><strong>æ´å¯Ÿï¼š</strong>${item.text}</li>`);
          });

          aovGuidelines.forEach(g => {
            const insightText = g.insight ? `${g.insight}ã€‚` : '';
            const suggestionText = g.suggestion || 'å»ºè­°æŒçºŒè§€å¯Ÿã€‚';
            insightItems.push(`<li><strong>AI æ´å¯Ÿï¼š</strong>${insightText}<span class="insight-suggestion">å»ºè­°ï¼š${suggestionText}</span></li>`);
          });

          aovTasks.forEach(task => {
            insightItems.push(`<li><strong>ä»»å‹™ï¼š</strong>${task.title} â€” ${task.description}</li>`);
          });

          aovAiInsightList.innerHTML = insightItems.length
            ? insightItems.join('')
            : '<li>ç›®å‰æ²’æœ‰é‡å°å®¢å–®åƒ¹çš„ AI å»ºè­°ã€‚</li>';
        }
      };

      const defaultAovSegment = document.querySelector('[data-aov-dimension].active')?.dataset.aovDimension || 'overall';
      updateAovModule(defaultAovSegment);

      // === æ¼æ–—åˆ†æ ===
      const funnelData = mockData.conversionFunnel || {};
      const funnelRanges = funnelData.ranges || [];
      const funnelProducts = funnelData.productSegments || [];
      const funnelCampaigns = funnelData.campaignSegments || [];

      const formatPercent = (value) => {
        if (Number.isNaN(value)) return 'â€”';
        return `${(Math.round(value * 10) / 10).toFixed(1)}%`;
      };

      const renderMainFunnel = (rangeId) => {
        const mainContainer = document.getElementById('mainFunnelVisual');
        if (!mainContainer) return;

        const rangeData = (funnelData.overall && funnelData.overall[rangeId]) || funnelData.overall?.[funnelRanges[0]?.id] || funnelData.overall?.['7d'] || { steps: [] };
        const steps = rangeData.steps || [];
        const subtitle = funnelRanges.find(r => r.id === rangeId)?.subtitle || funnelRanges[0]?.subtitle || '';

        const subtitleEl = document.getElementById('mainFunnelSubtitle');
        if (subtitleEl && subtitle) {
          subtitleEl.textContent = subtitle;
        }

        if (!steps.length) {
          mainContainer.innerHTML = '<p style="color:var(--color-gray-500);font-size:0.9rem;">ç›®å‰æ²’æœ‰å¯ç”¨çš„æ¼æ–—è³‡æ–™ã€‚</p>';
          return;
        }

        mainContainer.innerHTML = steps.map((step, index) => {
          const previousCount = index === 0 ? step.count : steps[index - 1].count;
          const fromPrevious = previousCount > 0 ? (step.count / previousCount) * 100 : 0;
          const fromOrigin = steps[0].count > 0 ? (step.count / steps[0].count) * 100 : 0;
          const converter = `
            <div class="funnel-step">
              <div class="funnel-step-info">
                <span class="funnel-step-label">${step.label}</span>
                <span class="funnel-step-count">${utils.formatNumber(step.count)}</span>
              </div>
              <div class="funnel-step-rate">
                <strong>${formatPercent(fromPrevious)}</strong>
                <span>ç›¸å°ä¸Šä¸€éšæ®µ</span>
                <span style="color:var(--color-gray-500);">ç´¯ç© ${formatPercent(fromOrigin)}</span>
              </div>
            </div>
          `;
          const connector = index < steps.length - 1 ? '<div class="funnel-connector"></div>' : '';
          return converter + connector;
        }).join('');
      };

      const renderMiniFunnel = (items, containerId) => {
        const container = document.getElementById(containerId);
        if (!container) return;

        if (!items || !items.length) {
          container.innerHTML = '<p style="color:var(--color-gray-500);font-size:0.9rem;">æš«ç„¡è³‡æ–™ã€‚</p>';
          return;
        }

        container.innerHTML = items.map(item => {
          const steps = item.steps || [];
          const firstCount = steps[0]?.count || 0;
          const lastCount = steps[steps.length - 1]?.count || 0;
          const overallRate = firstCount > 0 ? (lastCount / firstCount) * 100 : 0;
          const miniSteps = steps.map((step, index) => {
            const prev = index === 0 ? step.count : steps[index - 1].count;
            const rate = prev > 0 ? (step.count / prev) * 100 : 0;
            const width = Math.max(8, Math.min(rate, 100));
            const title = `${step.label}ï¼š${utils.formatNumber(step.count)} (${formatPercent(rate)})`;
            return `
              <div class="mini-funnel-step" title="${title}">
                <span>${step.label}</span>
                <div class="mini-funnel-bar"><span style="width:${width}%"></span></div>
                <span>${formatPercent(rate)}</span>
              </div>
            `;
          }).join('');

          return `
            <div class="mini-funnel-item">
              <div class="mini-funnel-header">
                <span>${item.name}</span>
                <span class="mini-funnel-overall">${formatPercent(overallRate)}</span>
              </div>
              <div class="mini-funnel-steps">
                ${miniSteps}
              </div>
            </div>
          `;
        }).join('');
      };

      const updateProductFunnel = (segmentId) => {
        const segment = funnelProducts.find(seg => seg.id === segmentId) || funnelProducts[0];
        const subtitle = document.getElementById('productFunnelSubtitle');
        if (subtitle && segment) {
          subtitle.textContent = `${segment.label}æ¼æ–—`;
        }
        renderMiniFunnel(segment?.items || [], 'productFunnelList');
      };

      const updateCampaignFunnel = (segmentId) => {
        const segment = funnelCampaigns.find(seg => seg.id === segmentId) || funnelCampaigns[0];
        const subtitle = document.getElementById('campaignFunnelSubtitle');
        if (subtitle && segment) {
          subtitle.textContent = `${segment.label}æ¼æ–—`;
        }
        renderMiniFunnel(segment?.items || [], 'campaignFunnelList');
      };

      const defaultFunnelRange = document.querySelector('[data-funnel-range].active')?.dataset.funnelRange || funnelRanges[0]?.id || '7d';
      renderMainFunnel(defaultFunnelRange);

      const defaultProductSegment = document.querySelector('[data-product-segment].active')?.dataset.productSegment || funnelProducts[0]?.id;
      if (defaultProductSegment) {
        updateProductFunnel(defaultProductSegment);
      }

      const defaultCampaignSegment = document.querySelector('[data-activity-segment].active')?.dataset.activitySegment || funnelCampaigns[0]?.id;
      if (defaultCampaignSegment) {
        updateCampaignFunnel(defaultCampaignSegment);
      }

      const funnelAiInsightList = document.getElementById('funnelAiInsightList');
      if (funnelAiInsightList) {
        const funnelGuidelines = guidelines.filter(g => g.category.includes('è½‰æ›ç‡'));
        const funnelTasks = tasks.filter(t => t.category === 'è½‰æ›ç‡');
        renderInsightList(funnelAiInsightList, funnelGuidelines, funnelTasks, 'ç›®å‰æ²’æœ‰æ–°çš„æ¼æ–—å„ªåŒ–å»ºè­°ã€‚');
      }

      // === æ§åˆ¶é …èˆ‡äº’å‹• ===
      const dataRangeSelect = document.getElementById('dataRangeSelect');
      if (dataRangeSelect) {
        dataRangeSelect.addEventListener('change', (event) => {
          const labelMap = {
            'yesterday': 'æ˜¨å¤© Â· èˆ‡å‰ä¸€å¤©æ¯”è¼ƒ',
            '30d': 'æœ€è¿‘ 30 å¤© Â· èˆ‡å‰ 30 å¤©æ¯”è¼ƒ',
            '7d': 'æœ€è¿‘ 7 å¤© Â· èˆ‡ä¸Šé€±åŒæœŸæ¯”è¼ƒ',
            'custom': 'è‡ªè¨‚ç¯„åœ Â· å¯é¸æ“‡æœ€å¤šä¸€å¹´'
          };
          if (dataRangeLabel) {
            dataRangeLabel.textContent = labelMap[event.target.value] || labelMap['7d'];
          }
        });
      }

      const dataCustomRangeBtn = document.getElementById('dataCustomRangeBtn');
      if (dataCustomRangeBtn) {
        dataCustomRangeBtn.addEventListener('click', () => {
          window.alert('è‡ªè¨‚æ—¥æœŸåŠŸèƒ½å³å°‡é–‹æ”¾ï¼Œæ­£å¼ç‰ˆå°‡æä¾›æ—¥æœŸé¸æ“‡å™¨ã€‚');
        });
      }

      const setupPillGroup = (selector, callback) => {
        const buttons = document.querySelectorAll(selector);
        if (!buttons.length) return;
        buttons.forEach(btn => {
          btn.addEventListener('click', () => {
            buttons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            if (typeof callback === 'function') callback(btn);
          });
        });
      };

      setupPillGroup('[data-traffic-source]', (btn) => updateTrafficModule(btn.dataset.trafficSource));
      setupPillGroup('[data-aov-dimension]', (btn) => updateAovModule(btn.dataset.aovDimension));
      setupPillGroup('[data-funnel-range]', (btn) => renderMainFunnel(btn.dataset.funnelRange));
      setupPillGroup('[data-product-segment]', (btn) => updateProductFunnel(btn.dataset.productSegment));
      setupPillGroup('[data-activity-segment]', (btn) => updateCampaignFunnel(btn.dataset.activitySegment));

      const exportBtn = document.getElementById('dataExportBtn');
      if (exportBtn) {
        exportBtn.addEventListener('click', () => {
          window.alert('åŒ¯å‡ºåŠŸèƒ½å°‡åœ¨æ­£å¼ç‰ˆæä¾›ï¼Œæ”¯æ´ Excel / PDF / åœ–ç‰‡æ ¼å¼ã€‚');
        });
      }
    })();
  </script>
</body>
</html>

